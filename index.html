<html>
  <head>
    <title>BuildingBlok JS Challenge</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" media="screen" title="no title" charset="utf-8">
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.0/angular.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script type="text/javascript">
      window.ourapp = {
        successRate: 0.7,
        offline: false,
        results: []
      };

      function _failure(record) {
        ourapp.results.push({saved: false, record: record, at: Date()});
      }

      function _success(record) {
        ourapp.results.push({saved: true, record: record, at: Date()});
      }

      function saveRecord(record) {
        if(ourapp.offline || Math.random() >= ourapp.successRate) {
          _failure(record);
          return false;
        } else {
          _success(record);
          return true;
        }
      }

      function recordStateCount() {
        return _.countBy(ourapp.results, function(record) {
          return record.saved ? 'saved' : 'queued';
        })
      }

      function toggleOffline() {
        ourapp.offline = !ourapp.offline;
        $status = $('#status');

        if(ourapp.offline) {
          $status.addClass('label-danger').removeClass('label-success').text('Offline');
        } else {
          $status.removeClass('label-danger').addClass('label-success').text('Online');
        }
      }

      function updateRecordCount() {
        var recordCount = recordStateCount();

        $('#saved-count').text(recordCount.saved || '0');
        $('#queued-count').text(recordCount.queued || '0');
      }

      function processQueue() {
        var queued = _.where(ourapp.results, {saved: false});
        var saved  = _.where(ourapp.results, {saved: true});

        ourapp.results = saved;

        _.each(queued, function(record){
          saveRecord(record.record);
        });
      }

      setInterval(function(){
        updateRecordCount();
      }, 100);

      setInterval(function(){
        if(!ourapp.offline) {
          processQueue();
        }
      },5000)

      //
      // Form handler with Angular
      //
      angular.module('formExample', [])
        .controller('ExampleController', ['$scope', function($scope) {
          $scope.master = {};

          $scope.save = function(user) {
            saveRecord(user)
          };
        }]);
    </script>
  </head>
  <body ng-app="formExample">
    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <br>
          <div ng-controller="ExampleController">
            <form novalidate class="simple-form">
              <div class="form-group">
                <label>Name</label>
                <input type="text" ng-model="user.name" class="form-control"/>
              </div>
              <div class="form-group">
                <label>Email</label>
                <input type="email" ng-model="user.email" class="form-control" />
              </div>
              <button type="submit" ng-click="save(user)" value="Save" class="btn btn-primary">Save</button>
            </form>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <hr>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6">
          <h1>Status:
            <span id="status" class="label label-success">Online</span>
          </h1>
          <br>
          <button onclick="toggleOffline()" class="btn btn-default">Toggle Offline</button>
        </div>
        <div class="col-md-6">
          <h1>
            Saved:
            <span id="saved-count">-</span>
          </p>
          <h1>
            Queued:
            <span id="queued-count">-</span>
          </p>
        </div>
      </div>
    </div>
  </body>
</html>
