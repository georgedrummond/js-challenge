<html>
  <head>
    <title>BuildingBlok JS Challenge</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" media="screen" title="no title" charset="utf-8">
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.0/angular.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script type="text/javascript">
      window.app = {
        successRate: 0.7,
        results: [],
        offline: false,

        saveRecord: function(record) {
          if(this.offline || Math.random() >= this.successRate) {
            this._failure(record);
            return false;
          } else {
            this._success(record);
            return true;
          }
        },

        toggleOffline: function() {
          this.offline = !this.offline;
          var $status = $('#status');

          if(this.offline) {
            $status.addClass('label-danger').removeClass('label-success').text('Offline');
          } else {
            $status.removeClass('label-danger').addClass('label-success').text('Online');
          }
        },

        updateRecordCount: function(){
          var recordCount = this._recordStateCount();

          $('#saved-count').text(recordCount.saved || '0');
          $('#queued-count').text(recordCount.queued || '0');
        },

        processQueue: function() {
          if(!app.offline) {
            var queued = _.where(this.results, {saved: false});
            var saved  = _.where(this.results, {saved: true});

            this.results = saved;

            _.each(queued, function(record){
              app.saveRecord(record.record);
            });
          }
        },

        _failure: function(record) {
          this.results.push({saved: false, record: record, at: Date()});
        },

        _success: function(record) {
          this.results.push({saved: true, record: record, at: Date()});
        },

        _recordStateCount: function() {
          return _.countBy(this.results, function(record) {
            return record.saved ? 'saved' : 'queued';
          });
        }
      }

      setInterval(function(){
        app.updateRecordCount();
      }, 100);

      setInterval(function(){
        app.processQueue();
      },5000)

      //
      // Form handler with Angular
      //
      angular.module('formExample', [])
        .controller('ExampleController', ['$scope', function($scope) {
          $scope.master = {};

          $scope.save = function(record) {
            app.saveRecord(record)
          };
        }]);
    </script>
  </head>
  <body ng-app="formExample">
    <br>
    <div class="container">
      <div class="row">
        <div class="col-md-6">
          <div class="well">
            <div ng-controller="ExampleController">
              <form novalidate class="simple-form">
                <div class="form-group">
                  <label>Country</label>
                  <input type="email" ng-model="record.country" class="form-control" />
                </div>
                <button type="submit" ng-click="save(record)" value="Save" class="btn btn-primary">Save</button>
              </form>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="well">
            <div ng-controller="ExampleController">
              <form novalidate class="simple-form">
                <div class="form-group">
                  <label>Name</label>
                  <input type="text" ng-model="record.name" class="form-control"/>
                </div>
                <div class="form-group">
                  <label>Email</label>
                  <input type="email" ng-model="record.email" class="form-control" />
                </div>
                <button type="submit" ng-click="save(record)" value="Save" class="btn btn-primary">Save</button>
              </form>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <hr>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6">
          <h1>Status:
            <span id="status" class="label label-success">Online</span>
          </h1>
          <br>
          <button onclick="app.toggleOffline()" class="btn btn-default">Toggle Offline</button>
        </div>
        <div class="col-md-6">
          <h1>
            Saved:
            <span id="saved-count">-</span>
          </p>
          <h1>
            Queued:
            <span id="queued-count">-</span>
          </p>
        </div>
      </div>
    </div>
  </body>
</html>
